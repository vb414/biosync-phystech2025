<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioSync - AI-Powered Personal Health Optimizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes grow {
            from { height: 0; }
            to { height: auto; }
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .notification {
            animation: slideIn 0.3s ease-out;
        }
        
        /* Chart bar animations */
        .chart-bar {
            animation: grow 0.5s ease-out;
            transition: height 0.3s ease-in-out;
        }
        
        /* Hover effects for metric cards */
        .metric-card {
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Progress bar animations */
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        
        /* Button animations */
        .btn-animated {
            transition: all 0.3s ease;
        }
        
        .btn-animated:hover {
            transform: scale(1.02);
        }
        
        /* Zone color classes */
        .zone-rest { background-color: #e5e7eb; color: #374151; }
        .zone-warm-up { background-color: #dbeafe; color: #1e40af; }
        .zone-fat-burn { background-color: #dcfce7; color: #166534; }
        .zone-aerobic { background-color: #fef3c7; color: #d97706; }
        .zone-cardio { background-color: #fed7aa; color: #ea580c; }
        .zone-peak { background-color: #fecaca; color: #dc2626; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        // Global variables with enhanced biometrics and fixed state management
        let currentStep = 'welcome';
        let userProfile = {
            name: '',
            age: '',
            gender: '',
            weight: '',
            height: '',
            activityLevel: '',
            fitnessGoals: [],
            medicalConditions: [],
            bmi: null,
            bmr: null,
            maxHeartRate: null
        };
        
        let isExercising = false;
        let exerciseDuration = 0;
        let exerciseInterval = null;
        
        // Enhanced biometrics with proper cooldown tracking
        let biometrics = {
            heartRate: 72,
            heartRateZone: 'rest',
            hydrationLevel: 100,
            glycogenStores: 100,
            coreTemp: 37.0,
            hydrationCooldown: 0,
            energyCooldown: 0,
            tempCooldown: 0,
            lastHydrationAlert: 0,
            lastEnergyAlert: 0,
            lastTempAlert: 0,
            sweatRate: 0
        };
        
        let recommendations = [];
        let historicalData = [];
        let medicalReport = null;
        let reportAnalysis = null;
        let completedRecommendations = {}; // Track completed recommendations

        // Helper functions
        function calculateBMI() {
            if (userProfile.weight && userProfile.height) {
                const height = parseFloat(userProfile.height) / 100;
                const weight = parseFloat(userProfile.weight);
                const age = parseInt(userProfile.age);
                const bmi = weight / (height * height);
                
                let bmr;
                if (userProfile.gender === 'male') {
                    bmr = 10 * weight + 6.25 * parseFloat(userProfile.height) - 5 * age + 5;
                } else {
                    bmr = 10 * weight + 6.25 * parseFloat(userProfile.height) - 5 * age - 161;
                }
                
                userProfile.bmi = bmi.toFixed(1);
                userProfile.bmr = Math.round(bmr);
                userProfile.maxHeartRate = 220 - age;
            }
        }
        
        // Enhanced updateBiometrics with proper cooldown system
        function updateBiometrics() {
            const intensity = { running: 2.2, cycling: 1.8, swimming: 2.0, strength: 1.5, yoga: 1.2 };
            const exerciseType = document.getElementById('exerciseType') ? document.getElementById('exerciseType').value : 'running';
            const multiplier = intensity[exerciseType] || 1.5;
            
            const baseHR = 72;
            const maxHR = userProfile.maxHeartRate || 190;
            const targetHR = Math.min(baseHR + (exerciseDuration * multiplier * 0.3), maxHR * 0.85);
            biometrics.heartRate = Math.round(biometrics.heartRate + (targetHR - biometrics.heartRate) * 0.1);
            
            // Update heart rate zone
            const hrPercent = (biometrics.heartRate - baseHR) / (maxHR - baseHR) * 100;
            if (hrPercent > 80) biometrics.heartRateZone = 'peak';
            else if (hrPercent > 70) biometrics.heartRateZone = 'cardio';
            else if (hrPercent > 60) biometrics.heartRateZone = 'aerobic';
            else if (hrPercent > 50) biometrics.heartRateZone = 'fat-burn';
            else if (hrPercent > 0) biometrics.heartRateZone = 'warm-up';
            else biometrics.heartRateZone = 'rest';
            
            // Calculate sweat rate
            const bodyWeightFactor = (parseFloat(userProfile.weight) || 70) / 70;
            biometrics.sweatRate = 0.5 * (hrPercent / 100) * bodyWeightFactor;
            
            // Decrease cooldowns
            if (biometrics.hydrationCooldown > 0) {
                biometrics.hydrationCooldown--;
            }
            if (biometrics.energyCooldown > 0) {
                biometrics.energyCooldown--;
            }
            if (biometrics.tempCooldown > 0) {
                biometrics.tempCooldown--;
            }
            
            // Only decrease hydration if cooldown is over
            if (biometrics.hydrationCooldown === 0) {
                const sweatRate = 0.3 * (hrPercent / 100) * (multiplier / 2);
                biometrics.hydrationLevel = Math.max(biometrics.hydrationLevel - sweatRate, 0);
            }
            
            // Only decrease energy if cooldown is over
            if (biometrics.energyCooldown === 0) {
                const energyBurn = 0.2 * (hrPercent / 100) * (multiplier / 2);
                biometrics.glycogenStores = Math.max(biometrics.glycogenStores - energyBurn, 0);
            }
            
            // Temperature management
            if (biometrics.tempCooldown === 0) {
                biometrics.coreTemp = Math.min(biometrics.coreTemp + 0.01, 39.5);
            } else {
                // Cool down faster when in cooldown
                biometrics.coreTemp = Math.max(biometrics.coreTemp - 0.02, 37.0);
            }
            
            // Update historical data for chart
            historicalData.push({
                time: exerciseDuration,
                heartRate: biometrics.heartRate,
                hydration: biometrics.hydrationLevel,
                glycogen: biometrics.glycogenStores,
                temp: biometrics.coreTemp
            });
            if (historicalData.length > 60) historicalData.shift(); // Keep last 60 points
            
            updateRecommendations();
            updateDynamicElements();
        }
        
        // Enhanced updateRecommendations with repeated alerts and proper tracking
        function updateRecommendations() {
            // Clear non-completed recommendations
            recommendations = recommendations.filter(r => r.completed);
            
            const exerciseType = document.getElementById('exerciseType') ? document.getElementById('exerciseType').value : 'running';
            
            // Always show status
            recommendations.unshift({
                id: 'status',
                title: `${userProfile.name}'s AI Analysis`,
                message: `Monitoring your ${exerciseType} session - ${Math.floor(exerciseDuration/60)}:${(exerciseDuration%60).toString().padStart(2,'0')} elapsed. Heart rate in ${biometrics.heartRateZone} zone.`,
                bgColor: 'bg-blue-50',
                actionable: false,
                completed: false
            });

            // HYDRATION - Show again after 60 seconds if still low
            if (biometrics.hydrationLevel < 90 && (exerciseDuration - biometrics.lastHydrationAlert) > 60) {
                const bodyWeight = parseFloat(userProfile.weight) || 70;
                const waterNeeded = Math.round((100 - biometrics.hydrationLevel) * bodyWeight * 0.015);
                const exerciseMultiplier = {
                    running: 1.3, cycling: 1.0, swimming: 0.8, strength: 1.1, yoga: 0.6
                }[exerciseType];
                const adjustedWater = Math.round(waterNeeded * exerciseMultiplier);
                
                let urgency = '';
                if (biometrics.hydrationLevel < 70) urgency = 'URGENT: ';
                else if (biometrics.hydrationLevel < 80) urgency = 'Important: ';
                
                recommendations.push({
                    id: `hydration_${exerciseDuration}`,
                    type: 'hydration',
                    title: `${urgency}Hydration Alert`,
                    message: `${userProfile.name}, drink ${adjustedWater}ml water now. As a ${userProfile.activityLevel} athlete (${bodyWeight}kg), your body needs extra hydration during ${exerciseType}.`,
                    bgColor: biometrics.hydrationLevel < 70 ? 'bg-red-50' : 'bg-blue-50',
                    actionable: true,
                    value: adjustedWater,
                    completed: false
                });
                biometrics.lastHydrationAlert = exerciseDuration;
            }

            // ENERGY - Show again after 90 seconds if still low
            if (biometrics.glycogenStores < 70 && (exerciseDuration - biometrics.lastEnergyAlert) > 90) {
                const baseCarbs = userProfile.gender === 'female' ? 25 : 30;
                const intensityMultiplier = {
                    running: 1.2, cycling: 1.0, swimming: 1.1, strength: 0.8, yoga: 0.5
                }[exerciseType];
                const recommendedCarbs = Math.round(baseCarbs * intensityMultiplier);
                
                recommendations.push({
                    id: `energy_${exerciseDuration}`,
                    type: 'energy',
                    title: `Energy Management for ${userProfile.gender.charAt(0).toUpperCase() + userProfile.gender.slice(1)} Athletes`,
                    message: `${userProfile.name}, consume ${recommendedCarbs}g quick carbs (banana, sports drink). ${userProfile.gender === 'female' ? 'Women' : 'Men'} typically need this amount during ${exerciseType} sessions lasting ${Math.floor(exerciseDuration/60)}+ minutes.`,
                    bgColor: 'bg-yellow-50',
                    actionable: true,
                    value: recommendedCarbs,
                    completed: false
                });
                biometrics.lastEnergyAlert = exerciseDuration;
            }

            // TEMPERATURE - Show again after 120 seconds if still high
            if (biometrics.coreTemp > 37.8 && (exerciseDuration - biometrics.lastTempAlert) > 120) {
                const ageWarning = userProfile.age > 50 ? ' Especially important at your age.' : '';
                recommendations.push({
                    id: `temp_${exerciseDuration}`,
                    type: 'cooling',
                    title: `Temperature Safety Alert`,
                    message: `${userProfile.name}, core temp elevated to ${biometrics.coreTemp.toFixed(1)}°C. Take a 2-minute cool-down break.${ageWarning}`,
                    bgColor: 'bg-red-50',
                    actionable: true,
                    value: 2,
                    completed: false
                });
                biometrics.lastTempAlert = exerciseDuration;
            }

            // Heart rate recommendations (non-actionable)
            if (biometrics.heartRateZone === 'peak') {
                const ageGroup = userProfile.age < 25 ? 'young athlete' : userProfile.age > 50 ? 'experienced athlete' : 'athlete';
                recommendations.push({
                    id: 'hr-peak',
                    title: `Peak Zone Alert for ${userProfile.age}-year-old`,
                    message: `${userProfile.name}, as a ${ageGroup}, reduce intensity to 70-85% max HR (${Math.round(userProfile.maxHeartRate * 0.7)}-${Math.round(userProfile.maxHeartRate * 0.85)} bpm) for optimal ${exerciseType} performance.`,
                    bgColor: 'bg-red-50',
                    actionable: false,
                    completed: false
                });
            } else if (biometrics.heartRateZone === 'cardio') {
                recommendations.push({
                    id: 'hr-cardio',
                    title: 'Perfect Cardio Zone Achievement',
                    message: `Excellent! Your ${biometrics.heartRate} bpm is ideal for your age (${userProfile.age}). This zone maximizes fat burn and cardiovascular benefits for ${exerciseType}.`,
                    bgColor: 'bg-green-50',
                    actionable: false,
                    completed: false
                });
            }

            // Add milestone celebrations
            if (exerciseDuration === 300) { // 5 minutes
                recommendations.push({
                    id: 'milestone-5',
                    title: `5-Minute Milestone! 🎉`,
                    message: `${userProfile.name}, you've hit 5 minutes! Your ${userProfile.activityLevel} fitness level is showing. Keep this ${exerciseType} pace for maximum benefit.`,
                    bgColor: 'bg-green-50',
                    actionable: false,
                    completed: false
                });
            }
        }

        // Enhanced notification function
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-red-500';
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 notification`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <span class="text-xl mr-2">${type === 'success' ? '✅' : type === 'warning' ? '⚠️' : '❌'}</span>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // Enhanced complete recommendation function
        function completeRecommendation(recId) {
            const rec = recommendations.find(r => r.id === recId);
            if (!rec || !rec.actionable || rec.completed) return;
            
            // Mark as completed
            rec.completed = true;
            completedRecommendations[recId] = rec;
            
            switch(rec.type) {
                case 'hydration':
                    // Increase hydration and set cooldown
                    biometrics.hydrationLevel = Math.min(100, biometrics.hydrationLevel + 20);
                    biometrics.hydrationCooldown = 45; // 45 seconds of no decrease
                    showNotification('💧 Hydration restored! You\'ll maintain this level for 45 seconds.', 'success');
                    break;
                    
                case 'energy':
                    // Increase energy and set cooldown
                    biometrics.glycogenStores = Math.min(100, biometrics.glycogenStores + 25);
                    biometrics.energyCooldown = 60; // 60 seconds of no decrease
                    showNotification('⚡ Energy boosted! Your glycogen stores are replenished for 60 seconds.', 'success');
                    break;
                    
                case 'cooling':
                    // Cool down temperature
                    biometrics.coreTemp = Math.max(37.0, biometrics.coreTemp - 0.3);
                    biometrics.heartRate = Math.max(72, biometrics.heartRate - 10);
                    biometrics.tempCooldown = 30; // 30 seconds of cooling
                    showNotification('🌡️ Cooling down! Your body temperature is normalizing for 30 seconds.', 'success');
                    break;
            }
            
            updateDynamicElements();
        }

        // Screen rendering functions
        function showWelcome() {
            currentStep = 'welcome';
            document.getElementById('root').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-pink-900 flex items-center justify-center p-4">
                    <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 24px; padding: 2rem; max-width: 600px; width: 100%; border: 1px solid rgba(255,255,255,0.2); text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">🧠</div>
                        <h1 style="font-size: 2.5rem; font-weight: bold; color: white; margin: 1rem 0;">
                            Welcome to BioSync
                        </h1>
                        <p style="color: rgba(255,255,255,0.8); font-size: 1.1rem; margin: 1.5rem 0; line-height: 1.6;">
                            AI-powered nutrition optimization that adapts to your unique physiology. 
                            Let's collect your personal information for personalized recommendations.
                        </p>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin: 2rem 0;">
                            <span style="font-size: 2rem;">🛡️</span>
                            <span style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                                Your data is secure and never shared
                            </span>
                        </div>
                        <button onclick="showProfile()" class="btn-animated" style="width: 100%; background: linear-gradient(to right, #3b82f6, #8b5cf6); color: white; font-weight: 600; padding: 1rem 2rem; border-radius: 12px; border: none; cursor: pointer; font-size: 1.1rem; transition: all 0.3s;">
                            Get Started
                        </button>
                    </div>
                </div>
            `;
        }
        
        function showProfile() {
            currentStep = 'profile';
            document.getElementById('root').innerHTML = `
                <div class="min-h-screen bg-gray-50 py-8">
                    <div class="max-w-2xl mx-auto px-4">
                        <div class="bg-white rounded-2xl shadow-xl p-8">
                            <h2 class="text-3xl font-bold text-gray-800 mb-6">Personal Profile</h2>
                            <form onsubmit="handleProfileSubmit(event)" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                                        <input type="text" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Enter your name" id="userName">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Age *</label>
                                        <input type="number" required min="10" max="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="25" id="userAge">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-3">Gender *</label>
                                    <div class="flex space-x-6">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="gender" value="male" required class="mr-2"> Male
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="gender" value="female" required class="mr-2"> Female
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="gender" value="other" required class="mr-2"> Other
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Weight (kg) *</label>
                                        <input type="number" required min="30" max="300" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="70" id="userWeight">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Height (cm) *</label>
                                        <input type="number" required min="100" max="250" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="175" id="userHeight">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Activity Level *</label>
                                    <select required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" id="activityLevel">
                                        <option value="">Select your activity level</option>
                                        <option value="sedentary">Sedentary (desk job, little exercise)</option>
                                        <option value="light">Light (exercise 1-3 days/week)</option>
                                        <option value="moderate">Moderate (exercise 3-5 days/week)</option>
                                        <option value="active">Active (exercise 6-7 days/week)</option>
                                        <option value="athlete">Athlete (intense daily training)</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Fitness Goals</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        ${['Weight Loss', 'Muscle Gain', 'Endurance', 'General Health', 'Performance', 'Recovery'].map(goal => `
                                            <label class="flex items-center cursor-pointer">
                                                <input type="checkbox" class="mr-2" id="goal_${goal.replace(' ', '_')}" value="${goal}">
                                                ${goal}
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Medical Conditions</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        ${['None', 'Diabetes', 'Hypertension', 'Heart Disease', 'Asthma', 'Thyroid'].map(condition => `
                                            <label class="flex items-center cursor-pointer">
                                                <input type="checkbox" class="mr-2" id="condition_${condition}" value="${condition}">
                                                ${condition}
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div id="calculatedMetrics" style="display: none;" class="bg-blue-50 rounded-lg p-4">
                                    <h3 class="font-semibold text-gray-800 mb-2">📊 Your Calculated Metrics:</h3>
                                    <div class="grid grid-cols-3 gap-4 text-sm">
                                        <div>
                                            <span class="text-gray-600">BMI:</span>
                                            <span class="font-semibold ml-2 text-blue-600" id="bmiDisplay"></span>
                                        </div>
                                        <div>
                                            <span class="text-gray-600">BMR:</span>
                                            <span class="font-semibold ml-2 text-green-600" id="bmrDisplay"></span>
                                        </div>
                                        <div>
                                            <span class="text-gray-600">Max HR:</span>
                                            <span class="font-semibold ml-2 text-red-600" id="maxHRDisplay"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white font-semibold py-3 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all btn-animated">
                                    Continue to Medical Information →
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners for real-time calculation
            setTimeout(() => {
                ['userName', 'userAge', 'userWeight', 'userHeight'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', updateProfileCalculations);
                    }
                });
                
                document.querySelectorAll('input[name="gender"]').forEach(radio => {
                    radio.addEventListener('change', updateProfileCalculations);
                });
            }, 100);
        }
        
        function updateProfileCalculations() {
            const name = document.getElementById('userName')?.value;
            const age = document.getElementById('userAge')?.value;
            const weight = document.getElementById('userWeight')?.value;
            const height = document.getElementById('userHeight')?.value;
            const gender = document.querySelector('input[name="gender"]:checked')?.value;
            
            if (age && weight && height && gender) {
                userProfile.age = age;
                userProfile.weight = weight;
                userProfile.height = height;
                userProfile.gender = gender;
                
                calculateBMI();
                
                document.getElementById('calculatedMetrics').style.display = 'block';
                document.getElementById('bmiDisplay').textContent = userProfile.bmi;
                document.getElementById('bmrDisplay').textContent = userProfile.bmr + ' cal/day';
                document.getElementById('maxHRDisplay').textContent = userProfile.maxHeartRate + ' bpm';
            }
        }
        
        function handleProfileSubmit(event) {
            event.preventDefault();
            
            userProfile.name = document.getElementById('userName').value;
            userProfile.age = document.getElementById('userAge').value;
            userProfile.weight = document.getElementById('userWeight').value;
            userProfile.height = document.getElementById('userHeight').value;
            userProfile.gender = document.querySelector('input[name="gender"]:checked').value;
            userProfile.activityLevel = document.getElementById('activityLevel').value;
            
            // Collect fitness goals
            userProfile.fitnessGoals = [];
            ['Weight Loss', 'Muscle Gain', 'Endurance', 'General Health', 'Performance', 'Recovery'].forEach(goal => {
                const checkbox = document.getElementById(`goal_${goal.replace(' ', '_')}`);
                if (checkbox && checkbox.checked) {
                    userProfile.fitnessGoals.push(goal);
                }
            });
            
            // Collect medical conditions
            userProfile.medicalConditions = [];
            ['None', 'Diabetes', 'Hypertension', 'Heart Disease', 'Asthma', 'Thyroid'].forEach(condition => {
                const checkbox = document.getElementById(`condition_${condition}`);
                if (checkbox && checkbox.checked) {
                    userProfile.medicalConditions.push(condition);
                }
            });
            
            calculateBMI();
            showMedical();
        }

        function showMedical() {
            currentStep = 'medical';
            document.getElementById('root').innerHTML = `
                <div class="min-h-screen bg-gray-50 py-8">
                    <div class="max-w-2xl mx-auto px-4">
                        <div class="bg-white rounded-2xl shadow-xl p-8">
                            <h2 class="text-3xl font-bold text-gray-800 mb-6">Medical Information</h2>
                             <p class="text-gray-600 mb-8">
                                Upload your recent medical report for personalized nutrition recommendations. 
                                This step is optional but highly recommended for the most accurate guidance.
                            </p>

                            <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center mb-6 hover:border-blue-400 transition-colors">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">📤</div>
                                <h3 class="text-xl font-semibold mb-2">Upload Medical Report</h3>
                                <p class="text-gray-600 mb-4">PDF, JPG, PNG, or any image format (Max 10MB)</p>
                                <input type="file" accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp" onchange="handleFileUpload(event)" class="hidden" id="medical-upload">
                                <label for="medical-upload" class="inline-block bg-blue-500 text-white px-6 py-3 rounded-lg cursor-pointer hover:bg-blue-600 transition-colors font-medium btn-animated">
                                    Choose File
                                </label>
                            </div>

                            <div id="uploadStatus" style="display: none;" class="bg-green-50 border-l-4 border-green-400 p-4 mb-6">
                                <div class="flex items-center">
                                    <span style="font-size: 1.5rem; margin-right: 0.75rem;">✅</span>
                                    <div>
                                        <p class="font-semibold text-green-800">File Uploaded Successfully!</p>
                                        <p class="text-green-700" id="fileName"></p>
                                        <p class="text-sm text-green-600 mt-1">Analyzing your medical data...</p>
                                    </div>
                                </div>
                            </div>

                            <div id="analysisResults" style="display: none;" class="bg-blue-50 rounded-xl p-6 mb-6">
                                <h3 class="font-semibold text-lg mb-4">🔬 Medical Report Analysis Results</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div class="bg-white p-4 rounded-lg">
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium">Blood Glucose:</span>
                                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold" id="glucoseStatus">
                                                Normal
                                            </span>
                                        </div>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg">
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium">Cholesterol:</span>
                                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold" id="cholesterolStatus">
                                                Normal
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-white p-4 rounded-lg">
                                    <h4 class="font-semibold mb-2">🎯 Personalized Recommendations:</h4>
                                    <ul class="space-y-1" id="medicalRecommendations">
                                        <li class="flex items-start text-sm">
                                            <span class="text-blue-500 mr-2">•</span>
                                            <span>Monitor hydration during exercise</span>
                                        </li>
                                        <li class="flex items-start text-sm">
                                            <span class="text-blue-500 mr-2">•</span>
                                            <span>Maintain balanced nutrition with adequate protein</span>
                                        </li>
                                        <li class="flex items-start text-sm">
                                            <span class="text-blue-500 mr-2">•</span>
                                            <span>Consider electrolyte supplementation for longer workouts</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <div class="bg-gray-50 rounded-xl p-4 mb-6">
                                <div class="flex items-start">
                                    <span style="font-size: 2rem; margin-right: 0.75rem;">🛡️</span>
                                    <div>
                                        <h4 class="font-semibold mb-1">Privacy & Security</h4>
                                        <p class="text-sm text-gray-600">
                                            Your medical data is processed locally in your browser and never stored on our servers. 
                                            All analysis happens in real-time and your data is completely private.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="flex space-x-4">
                                <button onclick="showProfile()" class="flex-1 bg-gray-200 text-gray-800 font-semibold py-3 rounded-lg hover:bg-gray-300 transition-colors btn-animated">
                                    ← Back
                                </button>
                                <button onclick="showDashboard()" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-semibold py-3 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all btn-animated">
                                    <span id="continueText">Skip & Continue</span> 🚀
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                medicalReport = file;
                
                // Show upload status
                document.getElementById('uploadStatus').style.display = 'block';
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('continueText').textContent = 'Start BioSync';
                
                // Simulate analysis after 2 seconds
                setTimeout(() => {
                    reportAnalysis = {
                        glucose: Math.random() > 0.7 ? 'normal' : 'low',
                        cholesterol: Math.random() > 0.6 ? 'normal' : 'high',
                        hemoglobin: Math.random() > 0.8 ? 'normal' : 'low',
                        recommendations: [
                            'Monitor hydration during exercise based on your glucose levels',
                            'Maintain balanced nutrition with adequate protein for your profile',
                            'Consider electrolyte supplementation for longer workouts',
                            'Track heart rate variability during exercise sessions'
                        ]
                    };
                    
                    // Update the analysis display
                    document.getElementById('glucoseStatus').textContent = reportAnalysis.glucose;
                    document.getElementById('glucoseStatus').className = `px-3 py-1 rounded-full text-sm font-semibold ${reportAnalysis.glucose === 'normal' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`;
                    
                    document.getElementById('cholesterolStatus').textContent = reportAnalysis.cholesterol;
                    document.getElementById('cholesterolStatus').className = `px-3 py-1 rounded-full text-sm font-semibold ${reportAnalysis.cholesterol === 'normal' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`;
                    
                    document.getElementById('medicalRecommendations').innerHTML = reportAnalysis.recommendations.map(rec => `
                        <li class="flex items-start text-sm">
                            <span class="text-blue-500 mr-2">•</span>
                            <span>${rec}</span>
                        </li>
                    `).join('');
                    
                    document.getElementById('analysisResults').style.display = 'block';
                }, 2000);
            }
        }

        function showDashboard() {
            currentStep = 'dashboard';
            renderDashboard();
        }

        function renderDashboard() {
            document.getElementById('root').innerHTML = `
                <div class="min-h-screen bg-gray-50">
                    <!-- Header -->
                    <header class="bg-white shadow-sm border-b">
                        <div class="max-w-7xl mx-auto px-4 py-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <span style="font-size: 2rem;">🧠</span>
                                    <div>
                                        <h1 class="text-2xl font-bold">BioSync</h1>
                                        <p class="text-sm text-gray-600">Welcome back, ${userProfile.name}!</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <select id="exerciseType" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" ${isExercising ? 'disabled' : ''}>
                                        <option value="running">🏃 Running</option>
                                        <option value="cycling">🚴 Cycling</option>
                                        <option value="swimming">🏊 Swimming</option>
                                        <option value="strength">💪 Strength</option>
                                        <option value="yoga">🧘 Yoga</option>
                                    </select>
                                    <button onclick="toggleExercise()" class="px-6 py-2 rounded-lg font-semibold text-white transition-all btn-animated ${isExercising ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'}">
                                        ${isExercising ? '⏹️ Stop Exercise' : '▶️ Start Exercise'}
                                    </button>
                                    ${isExercising ? `<div class="font-mono text-lg font-bold text-blue-600 animate-pulse">${Math.floor(exerciseDuration / 60)}:${(exerciseDuration % 60).toString().padStart(2, '0')}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    </header>

                    <!-- User Info Bar -->
                    <div class="bg-blue-50 border-b px-4 py-3">
                        <div class="max-w-7xl mx-auto flex items-center justify-between text-sm">
                            <div class="flex items-center space-x-6">
                                <span>👤 <strong>Age:</strong> ${userProfile.age}</span>
                                <span>📏 <strong>BMI:</strong> ${userProfile.bmi}</span>
                                <span>🏃 <strong>Level:</strong> ${userProfile.activityLevel}</span>
                                <span>❤️ <strong>Max HR:</strong> ${userProfile.maxHeartRate} bpm</span>
                                ${isExercising ? '<span class="text-green-600 font-bold animate-pulse">🟢 EXERCISE ACTIVE</span>' : '<span class="text-gray-500">⚪ Ready to Exercise</span>'}
                            </div>
                        </div>
                    </div>

                    <!-- Main Dashboard -->
                    <main class="max-w-7xl mx-auto px-4 py-8">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Biometric Cards -->
                            <div class="lg:col-span-2 grid grid-cols-2 md:grid-cols-4 gap-4">
                                <!-- Heart Rate Card -->
                                <div class="bg-red-50 rounded-xl p-4 hover:shadow-lg transition-all metric-card">
                                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">❤️</div>
                                    <div class="text-2xl font-bold" id="heartRateDisplay">${biometrics.heartRate}</div>
                                    <div class="text-sm text-gray-600">Heart Rate</div>
                                    <div class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full mt-2 inline-block zone-${biometrics.heartRateZone.replace(' ', '-')}" id="heartRateZone">
                                        ${biometrics.heartRateZone}
                                    </div>
                                </div>
                                
                                <!-- Hydration Card -->
                                <div class="bg-blue-50 rounded-xl p-4 hover:shadow-lg transition-all metric-card">
                                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">💧</div>
                                    <div class="text-2xl font-bold" id="hydrationDisplay">${Math.round(biometrics.hydrationLevel)}%</div>
                                    <div class="text-sm text-gray-600">Hydration</div>
                                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                        <div id="hydrationBar" class="bg-blue-500 h-2 rounded-full transition-all duration-500 progress-bar" style="width: ${biometrics.hydrationLevel}%"></div>
                                    </div>
                                    <div id="hydrationCooldown" class="text-xs text-green-600 mt-1" style="display: ${biometrics.hydrationCooldown > 0 ? 'block' : 'none'}">Protected: ${biometrics.hydrationCooldown}s</div>
                                </div>
                                
                                <!-- Energy Card -->
                                <div class="bg-yellow-50 rounded-xl p-4 hover:shadow-lg transition-all metric-card">
                                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">⚡</div>
                                    <div class="text-2xl font-bold" id="energyDisplay">${Math.round(biometrics.glycogenStores)}%</div>
                                    <div class="text-sm text-gray-600">Energy</div>
                                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                        <div id="energyBar" class="bg-yellow-500 h-2 rounded-full transition-all duration-500 progress-bar" style="width: ${biometrics.glycogenStores}%"></div>
                                    </div>
                                    <div id="energyCooldown" class="text-xs text-green-600 mt-1" style="display: ${biometrics.energyCooldown > 0 ? 'block' : 'none'}">Protected: ${biometrics.energyCooldown}s</div>
                                </div>
                                
                                <!-- Temperature Card -->
                                <div class="bg-orange-50 rounded-xl p-4 hover:shadow-lg transition-all metric-card">
                                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">🌡️</div>
                                    <div class="text-2xl font-bold" id="tempDisplay">${biometrics.coreTemp.toFixed(1)}°C</div>
                                    <div class="text-sm text-gray-600">Core Temp</div>
                                    <div class="text-xs mt-2 px-2 py-1 rounded-full inline-block ${biometrics.coreTemp > 38.0 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}" id="tempStatus">
                                        ${biometrics.coreTemp > 38.0 ? '⚠️ High' : '✅ Normal'}
                                    </div>
                                    <div id="tempCooldown" class="text-xs text-blue-600 mt-1" style="display: ${biometrics.tempCooldown > 0 ? 'block' : 'none'}">Cooling: ${biometrics.tempCooldown}s</div>
                                </div>
                            </div>

                            <!-- AI Recommendations -->
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold mb-4 flex items-center">
                                    🧠 AI Recommendations
                                </h3>
                                <div id="recommendationsContainer" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                                    <!-- Recommendations will be updated dynamically -->
                                </div>
                            </div>

                            <!-- Performance Chart -->
                            <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold mb-4">📊 Real-Time Performance</h3>
                                <div class="h-64 bg-gray-50 rounded-lg p-4">
                                    <div id="performanceChart" class="h-full w-full flex items-end space-x-1">
                                        <!-- Chart bars will be generated here -->
                                    </div>
                                </div>
                                
                                <div id="statsContainer" class="mt-4">
                                    <!-- Stats will be updated dynamically -->
                                </div>
                            </div>

                            <!-- Personal Stats -->
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold mb-4 flex items-center">
                                    👤 Your Personal Stats
                                </h3>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                        <span class="text-gray-600">🔥 Daily Calories:</span>
                                        <span class="font-bold text-orange-600">${Math.round((userProfile.bmr || 1680) * 1.5)} cal</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                        <span class="text-gray-600">💧 Water Needs:</span>
                                        <span class="font-bold text-blue-600">${Math.round((parseFloat(userProfile.weight) || 70) * 35)} ml/day</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                        <span class="text-gray-600">🎯 Goals:</span>
                                        <span class="font-bold text-purple-600 text-sm">${userProfile.fitnessGoals.slice(0, 2).join(', ') || 'General Health'}</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                        <span class="text-gray-600">📈 Status:</span>
                                        <span class="font-bold ${isExercising ? 'text-green-600' : 'text-gray-600'}" id="exerciseStatus">${isExercising ? '🏃 Exercising' : '😌 Resting'}</span>
                                    </div>
                                    ${userProfile.medicalConditions.length > 0 && userProfile.medicalConditions[0] !== 'None' ? `
                                        <div class="p-3 bg-yellow-50 rounded-lg border-l-4 border-yellow-400">
                                            <span class="text-sm font-medium text-yellow-800">⚠️ Medical Conditions:</span>
                                            <p class="text-sm text-yellow-700 mt-1">
                                                ${userProfile.medicalConditions.filter(c => c !== 'None').join(', ')}
                                            </p>
                                        </div>
                                    ` : ''}
                                    
                                    ${reportAnalysis ? `
                                        <div class="p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                                            <span class="text-sm font-medium text-blue-800">📋 Medical Analysis:</span>
                                            <p class="text-sm text-blue-700 mt-1">
                                                Glucose: ${reportAnalysis.glucose} | Cholesterol: ${reportAnalysis.cholesterol}
                                            </p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            `;
            
            // Initial update of dynamic elements
            updateDynamicElements();
        }

        // Function to update only the dynamic parts - FIXED VERSION
        function updateDynamicElements() {
            // Update biometric displays
            const heartRateEl = document.getElementById('heartRateDisplay');
            if (heartRateEl) heartRateEl.textContent = biometrics.heartRate;
            
            const heartRateZoneEl = document.getElementById('heartRateZone');
            if (heartRateZoneEl) {
                heartRateZoneEl.textContent = biometrics.heartRateZone;
                heartRateZoneEl.className = `text-xs px-2 py-1 rounded-full mt-2 inline-block zone-${biometrics.heartRateZone.replace(' ', '-')}`;
            }
            
            const hydrationEl = document.getElementById('hydrationDisplay');
            if (hydrationEl) hydrationEl.textContent = Math.round(biometrics.hydrationLevel) + '%';
            
            const hydrationBar = document.getElementById('hydrationBar');
            if (hydrationBar) hydrationBar.style.width = biometrics.hydrationLevel + '%';
            
            const hydrationCooldown = document.getElementById('hydrationCooldown');
            if (hydrationCooldown) {
                if (biometrics.hydrationCooldown > 0) {
                    hydrationCooldown.textContent = `Protected: ${biometrics.hydrationCooldown}s`;
                    hydrationCooldown.style.display = 'block';
                } else {
                    hydrationCooldown.style.display = 'none';
                }
            }
            
            const energyEl = document.getElementById('energyDisplay');
            if (energyEl) energyEl.textContent = Math.round(biometrics.glycogenStores) + '%';
            
            const energyBar = document.getElementById('energyBar');
            if (energyBar) energyBar.style.width = biometrics.glycogenStores + '%';
            
            const energyCooldown = document.getElementById('energyCooldown');
            if (energyCooldown) {
                if (biometrics.energyCooldown > 0) {
                    energyCooldown.textContent = `Protected: ${biometrics.energyCooldown}s`;
                    energyCooldown.style.display = 'block';
                } else {
                    energyCooldown.style.display = 'none';
                }
            }
            
            const tempEl = document.getElementById('tempDisplay');
            if (tempEl) tempEl.textContent = biometrics.coreTemp.toFixed(1) + '°C';
            
            const tempStatus = document.getElementById('tempStatus');
            if (tempStatus) {
                tempStatus.textContent = biometrics.coreTemp > 38.0 ? '⚠️ High' : '✅ Normal';
                tempStatus.className = `text-xs mt-2 px-2 py-1 rounded-full inline-block ${biometrics.coreTemp > 38.0 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            }
            
            const tempCooldown = document.getElementById('tempCooldown');
            if (tempCooldown) {
                if (biometrics.tempCooldown > 0) {
                    tempCooldown.textContent = `Cooling: ${biometrics.tempCooldown}s`;
                    tempCooldown.style.display = 'block';
                } else {
                    tempCooldown.style.display = 'none';
                }
            }
            
            // Update recommendations
            updateRecommendationsDisplay();
            
            // Update performance chart
            updatePerformanceChart();
            
            // Update stats
            updateStatsDisplay();
        }

        // Function to update recommendations display - FIXED VERSION
        function updateRecommendationsDisplay() {
            const container = document.getElementById('recommendationsContainer');
            if (!container) return;
            
            if (recommendations.length > 0) {
                container.innerHTML = recommendations.map((rec) => `
                    <div class="${rec.bgColor} rounded-lg p-3 border-l-4 border-blue-500 ${rec.completed ? 'opacity-50' : ''} transition-all hover:shadow-md">
                        <h4 class="font-semibold text-sm ${rec.completed ? 'line-through' : ''}">${rec.title}</h4>
                        <p class="text-xs text-gray-700 mt-1">${rec.message}</p>
                        ${rec.actionable && !rec.completed ? `
                            <button onclick="completeRecommendation('${rec.id}')" class="mt-2 px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-all btn-animated">
                                ✓ Done
                            </button>
                        ` : ''}
                        ${rec.completed ? '<span class="text-xs text-green-600 mt-2 inline-block">✅ Completed</span>' : ''}
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">📊</div>
                        <p class="text-gray-500">${isExercising ? 'AI analyzing your performance...' : 'Start exercising to receive AI recommendations!'}</p>
                    </div>
                `;
            }
            
            // Add medical recommendations if available
            if (reportAnalysis && reportAnalysis.recommendations && isExercising) {
                container.innerHTML += `
                    <div class="mt-4 pt-4 border-t">
                        <h4 class="font-semibold text-sm mb-2">📋 From your medical report:</h4>
                        <ul class="text-xs text-gray-600 space-y-1">
                            ${reportAnalysis.recommendations.map(rec => `
                                <li class="flex items-start">
                                    <span class="mr-2">•</span>
                                    <span>${rec}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }
        }

        // Function to update performance chart - FIXED REAL-TIME VERSION
        function updatePerformanceChart() {
            const container = document.getElementById('performanceChart');
            if (!container) return;
            
            if (historicalData.length === 0) {
                container.innerHTML = `
                    <div class="w-full h-full flex items-center justify-center text-gray-500">
                        <div class="text-center">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">📈</div>
                            <p>Start exercising to see your real-time performance data</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            const maxHR = Math.max(...historicalData.map(d => d.heartRate), 100);
            const minHR = Math.min(...historicalData.map(d => d.heartRate), 60);
            const range = maxHR - minHR || 1;
            
            // Generate chart bars
            const chartBars = historicalData.slice(-30).map((data, i) => {
                const heightPercent = ((data.heartRate - minHR) / range) * 100;
                const hydrationOpacity = data.hydration / 100;
                
                return `
                    <div class="flex-1 flex flex-col justify-end chart-bar" style="min-width: 8px; max-width: 20px;">
                        <div class="bg-gradient-to-t from-red-500 to-red-400 rounded-t transition-all duration-300 hover:from-red-600 hover:to-red-500" 
                             style="height: ${Math.max(heightPercent, 5)}%; min-height: 4px; opacity: ${hydrationOpacity};"
                             title="Time: ${data.time}s | HR: ${data.heartRate} bpm | Hydration: ${Math.round(data.hydration)}% | Energy: ${Math.round(data.glycogen)}%">
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = chartBars;
        }

        // Function to update stats display
        function updateStatsDisplay() {
            const container = document.getElementById('statsContainer');
            if (!container || !isExercising || historicalData.length === 0) {
                if (container) container.innerHTML = '';
                return;
            }
            
            const avgHR = Math.round(historicalData.reduce((sum, d) => sum + d.heartRate, 0) / historicalData.length);
            const avgHydration = Math.round(historicalData.reduce((sum, d) => sum + d.hydration, 0) / historicalData.length);
            const caloriesBurned = Math.round(exerciseDuration * 0.15 * (parseFloat(userProfile.weight) || 70) / 60);
            const sweatLoss = (biometrics.sweatRate * exerciseDuration / 3600).toFixed(1);
            
            container.innerHTML = `
                <div class="grid grid-cols-4 gap-4 text-center">
                    <div class="bg-red-50 p-3 rounded-lg hover:bg-red-100 transition-colors">
                        <p class="text-sm text-gray-600">Avg Heart Rate</p>
                        <p class="text-lg font-bold text-red-600">${avgHR} bpm</p>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-lg hover:bg-orange-100 transition-colors">
                        <p class="text-sm text-gray-600">Calories Burned</p>
                        <p class="text-lg font-bold text-orange-600">${caloriesBurned} cal</p>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg hover:bg-blue-100 transition-colors">
                        <p class="text-sm text-gray-600">Avg Hydration</p>
                        <p class="text-lg font-bold text-blue-600">${avgHydration}%</p>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg hover:bg-purple-100 transition-colors">
                        <p class="text-sm text-gray-600">Duration</p>
                        <p class="text-lg font-bold text-purple-600">
                            ${Math.floor(exerciseDuration / 60)}:${(exerciseDuration % 60).toString().padStart(2, '0')}
                        </p>
                    </div>
                </div>
                
                <div class="mt-4 text-center">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-sm text-gray-600">Estimated Sweat Loss</p>
                        <p class="text-lg font-bold text-gray-700">${sweatLoss}L</p>
                    </div>
                </div>
            `;
        }

        // FIXED Toggle exercise function
        function toggleExercise() {
            if (!isExercising) {
                // Start exercise
                isExercising = true;
                exerciseDuration = 0;
                historicalData = [];
                recommendations = [];
                completedRecommendations = {};
                
                // Reset alert timings
                biometrics.lastHydrationAlert = 0;
                biometrics.lastEnergyAlert = 0;
                biometrics.lastTempAlert = 0;
                
                // Reset cooldowns
                biometrics.hydrationCooldown = 0;
                biometrics.energyCooldown = 0;
                biometrics.tempCooldown = 0;
                
                showNotification('🏃 Exercise session started! AI monitoring activated.', 'success');
                
                exerciseInterval = setInterval(() => {
                    exerciseDuration++;
                    updateBiometrics();
                }, 1000);
                
                // Update the UI immediately
                renderDashboard();
            } else {
                // Stop exercise
                isExercising = false;
                if (exerciseInterval) {
                    clearInterval(exerciseInterval);
                    exerciseInterval = null;
                }
                
                const totalCalories = Math.round(exerciseDuration * 0.15 * (parseFloat(userProfile.weight) || 70) / 60);
                const sessionDuration = `${Math.floor(exerciseDuration / 60)}:${(exerciseDuration % 60).toString().padStart(2, '0')}`;
                
                showNotification(`🏁 Exercise completed! Duration: ${sessionDuration}, Calories: ${totalCalories}`, 'success');
                
                // Reset biometrics gradually
                setTimeout(() => {
                    biometrics = {
                        heartRate: 72,
                        heartRateZone: 'rest',
                        hydrationLevel: 100,
                        glycogenStores: 100,
                        coreTemp: 37.0,
                        hydrationCooldown: 0,
                        energyCooldown: 0,
                        tempCooldown: 0,
                        lastHydrationAlert: 0,
                        lastEnergyAlert: 0,
                        lastTempAlert: 0,
                        sweatRate: 0
                    };
                    recommendations = [];
                    completedRecommendations = {};
                    exerciseDuration = 0;
                    
                    renderDashboard();
                }, 2000);
                
                // Update UI immediately to show stopped state
                renderDashboard();
            }
        }
        
        // Utility functions
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
        
        function getHeartRateZoneColor(zone) {
            const colors = {
                'rest': 'bg-gray-100 text-gray-600',
                'warm-up': 'bg-blue-100 text-blue-600',
                'fat-burn': 'bg-green-100 text-green-600',
                'aerobic': 'bg-yellow-100 text-yellow-600',
                'cardio': 'bg-orange-100 text-orange-600',
                'peak': 'bg-red-100 text-red-600'
            };
            return colors[zone] || 'bg-gray-100 text-gray-600';
        }
        
        // Enhanced error handling
        window.addEventListener('error', function(e) {
            console.error('BioSync Error:', e.error);
            showNotification('An error occurred. Please refresh the page if issues persist.', 'error');
        });
        
        // Prevent accidental page refresh during exercise
        window.addEventListener('beforeunload', function(e) {
            if (isExercising) {
                e.preventDefault();
                e.returnValue = 'You have an active exercise session. Are you sure you want to leave?';
                return e.returnValue;
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Space bar to toggle exercise (only on dashboard)
            if (e.code === 'Space' && currentStep === 'dashboard' && !e.target.matches('input, textarea, select')) {
                e.preventDefault();
                toggleExercise();
            }
            
            // Escape to stop exercise
            if (e.code === 'Escape' && isExercising) {
                toggleExercise();
            }
        });
        
        // Visibility change handling (pause when tab is not visible)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isExercising) {
                // Optionally pause or continue in background
                console.log('BioSync: Tab hidden, exercise continues in background');
            } else if (!document.hidden && isExercising) {
                console.log('BioSync: Tab visible, exercise tracking active');
            }
        });
        
        // Auto-save user progress to localStorage (optional)
        function saveProgress() {
            if (typeof(Storage) !== "undefined") {
                const progressData = {
                    userProfile: userProfile,
                    timestamp: Date.now()
                };
                localStorage.setItem('biosync_progress', JSON.stringify(progressData));
            }
        }
        
        function loadProgress() {
            if (typeof(Storage) !== "undefined") {
                const saved = localStorage.getItem('biosync_progress');
                if (saved) {
                    const data = JSON.parse(saved);
                    // Only load if saved within last 24 hours
                    if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                        return data.userProfile;
                    }
                }
            }
            return null;
        }
        
        // Performance monitoring
        function logPerformanceMetrics() {
            if (isExercising && exerciseDuration % 30 === 0) { // Every 30 seconds
                const metrics = {
                    duration: exerciseDuration,
                    heartRate: biometrics.heartRate,
                    hydration: biometrics.hydrationLevel,
                    energy: biometrics.glycogenStores,
                    temperature: biometrics.coreTemp,
                    recommendations: recommendations.length,
                    timestamp: Date.now()
                };
                console.log('BioSync Metrics:', metrics);
            }
        }
        
        // Add performance logging to biometric updates
        const originalUpdateBiometrics = updateBiometrics;
        updateBiometrics = function() {
            originalUpdateBiometrics();
            logPerformanceMetrics();
        };
        
        // Initialize the app with progress loading
        function initializeBioSync() {
            // Try to load saved progress
            const savedProfile = loadProgress();
            if (savedProfile && savedProfile.name) {
                userProfile = { ...userProfile, ...savedProfile };
                showNotification(`Welcome back, ${userProfile.name}! 👋`, 'success');
                // Could optionally ask if they want to continue with saved data
            }
            
            // Start with welcome screen
            showWelcome();
            
            console.log('🧠 BioSync initialized successfully!');
            console.log('💡 Tip: Press Space to start/stop exercise, Escape to stop');
        }
        
        // Save progress when profile is updated
        const originalHandleProfileSubmit = handleProfileSubmit;
        handleProfileSubmit = function(event) {
            originalHandleProfileSubmit(event);
            saveProgress();
        };
        
        // Initialize the app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeBioSync);
        } else {
            initializeBioSync();
        }
        
    </script>
</body>
</html>
